version: 2
jobs:
  build:
    branches:
      only:
        - zCatch-0.7.x
    docker:
      - image: buildpack-deps:buster
    steps:
      - checkout
      - run:
          name: Prepare
          command: |
            apt-get update -y
            apt-get install cmake libfreetype6-dev libsdl2-dev -y
            git submodule update --init --recursive
      - run:
          name: Build teeworlds with cmake in Release mode
          command: |
            mkdir -p release
            cd release
            env CFLAGS="-Wdeclaration-after-statement -Wno-error" CXXFLAGS="-Wno-error" cmake -Wno-error=dev -DDOWNLOAD_GTEST=ON ..
            make everything
            make run_tests
            ./zcatch_srv shutdown
      - run:
          name: Build teeworlds with cmake in Debug mode
          command: |
            mkdir -p debug
            cd debug
            env CFLAGS="-Wdeclaration-after-statement -Wno-error" CXXFLAGS="-Wno-error" cmake -Wno-error=dev -DDOWNLOAD_GTEST=ON -DDEV=ON ..
            make everything
            make run_tests
            ./zcatch_srv shutdown
